<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ControlDeck: cd_control_deck.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>cd_control_deck.h</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *  cd_control_deck.h</span>
<a name="l00003"></a>00003 <span class="comment"> *  ControlDeck</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *  Created by David Wilson on 2/13/08.</span>
<a name="l00006"></a>00006 <span class="comment"> *  Copyright 2008 Princeton Satellite Systems. All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> */</span>
<a name="l00009"></a>00009  
<a name="l00010"></a>00010 <span class="preprocessor">#ifndef __CD_CONTROL_DECK__</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#define __CD_CONTROL_DECK__</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;DSUtils/DSUtils.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;DSimEngine2/DSimEngine2.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;cd_control_module.h&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;cd_control_system.h&quot;</span>
<a name="l00017"></a>00017 
<a name="l00192"></a>00192 <span class="keyword">class </span>cd_data_point;
<a name="l00193"></a>00193 <span class="keyword">class </span><a class="code" href="classcd__control__system.html" title="The system class which manages a set of modules.">cd_control_system</a>;
<a name="l00194"></a>00194 
<a name="l00199"></a><a class="code" href="group___control_deck.html#ga665fe1a1f466a4f724d3f34741edbfcb">00199</a> <span class="preprocessor">#define CD_SYSTEM_GROUP             &quot;__cd_system_group&quot;</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>
<a name="l00204"></a><a class="code" href="group___control_deck.html#ga33479112f5770ce9d4e525004d0c92e6">00204</a> <span class="preprocessor">#define CD_SIMULATION_STEP_EVENT    &quot;__cd_simulation_step_event&quot;</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>
<a name="l00213"></a><a class="code" href="classcd__control__deck.html">00213</a> <span class="keyword">class </span><a class="code" href="classcd__control__deck.html" title="ControlDeck manager class.">cd_control_deck</a>
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215     <span class="keyword">public</span>:
<a name="l00217"></a>00217         <a class="code" href="classcd__control__deck.html#a2744fa2f48bf2bdeb3be519098fdbdf4" title="Create a new control deck, with an optional setup file.">cd_control_deck</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *control_setup_file = NULL);
<a name="l00219"></a>00219         <a class="code" href="classcd__control__deck.html#a331ce8a8e408e1f89f2628399de48799" title="Destructor.">~cd_control_deck</a>();
<a name="l00220"></a>00220         
<a name="l00221"></a>00221         <span class="comment">// DSim Integration</span>
<a name="l00223"></a>00223 <span class="comment"></span>        <span class="keywordtype">bool</span> <a class="code" href="classcd__control__deck.html#a78bf89868408e08675b748a48d9c21c3" title="Load a simulation setup file, and map any variables that are marked with cd_mapped_variable.">include_simulation</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *setup_file);
<a name="l00225"></a>00225         <span class="keywordtype">bool</span> <a class="code" href="classcd__control__deck.html#a5bb580b48fcf70709b3a7cd62692e785" title="Map a single simulation variable from the dsim simulation to a ControlDeck data point.">map_simulation_variable</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *dsim_path,<span class="keyword">const</span> <span class="keywordtype">char</span> *cd_group,<span class="keyword">const</span> <span class="keywordtype">char</span> *cd_path);
<a name="l00226"></a>00226         
<a name="l00227"></a>00227         <span class="comment">// Control System Integration</span>
<a name="l00229"></a>00229 <span class="comment"></span>        <span class="keywordtype">bool</span> <a class="code" href="classcd__control__deck.html#a06984a4e49af5689adf9ec2a6e34c5bd" title="Add a control system to the deck. Adding will fail if the new system has the same name as an existing...">add_control_system</a>(<a class="code" href="classcd__control__system.html" title="The system class which manages a set of modules.">cd_control_system</a> *system);
<a name="l00230"></a>00230         <a class="code" href="classcd__control__system.html" title="The system class which manages a set of modules.">cd_control_system</a> *control_system_named(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> (<a class="code" href="classcd__control__system.html" title="The system class which manages a set of modules.">cd_control_system</a> *)systems.lookup(name); }
<a name="l00231"></a>00231         
<a name="l00232"></a>00232         <span class="comment">// Run management</span>
<a name="l00234"></a>00234 <span class="comment"></span>        <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#ad57d380309305a86a0a213220033d72f" title="Set the timescale used by the deck. The number provided is a multiple of real-time; a 2...">set_time_scale</a>(<span class="keywordtype">double</span> scale);
<a name="l00236"></a>00236         <span class="keywordtype">double</span> <a class="code" href="classcd__control__deck.html#a9581577813ad521ca9296c862a2d79a6" title="Get the timescale used by the deck.">time_scale</a>();
<a name="l00238"></a>00238         <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#a7853a9f3062b8b61aac8b4b9942dae93" title="Initialize the control deck. This function must be called before run();.">initialize</a>();
<a name="l00239"></a>00239         
<a name="l00241"></a>00241         <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#a9d5a2ee6678dcec002f776d8c910ca78" title="Cause the ControlDeck to call the provided callback for all variables that have been marked as teleme...">note_marked_variables</a>(<span class="keywordtype">void</span> (*note_callback)(<span class="keywordtype">void</span> *ctx,<span class="keyword">const</span> <span class="keywordtype">char</span> *path,cd_data_point *pt,<span class="keywordtype">bool</span> is_telemetry,<span class="keywordtype">bool</span> is_command),<span class="keywordtype">void</span> *ctx);
<a name="l00243"></a>00243         <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#ac9f5b36cefdd9b50b1633f7ba63b4a5f" title="Set up the ControlDeck to start the run loop.">start</a>();
<a name="l00245"></a>00245         <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#ae01c661ce9d325c1427a3b04a0a5c215" title="Reset the ControlDeck&amp;#39;s next loop timers to deal with time slippage (as from a pause)...">resume_from_pause</a>();
<a name="l00247"></a>00247         ds_date <a class="code" href="classcd__control__deck.html#ae0d4de7e26a5a67ee746ee3772bdff52" title="Run a single step of the run loop.">run_step</a>();
<a name="l00249"></a>00249         ds_date <a class="code" href="classcd__control__deck.html#ad33975a3065e560925e3c407d3f6c6b6" title="Delay a run loop by a period of time.">delay_step</a>(<span class="keyword">const</span> ds_time_interval &amp;delay);
<a name="l00251"></a>00251         <span class="keywordtype">void</span> <a class="code" href="classcd__control__deck.html#a73c3f494bc4b06187be8e3dd35a11443" title="Run the control deck. This function generally will never return (control deck errors call exit(1))...">run</a>();
<a name="l00252"></a>00252         
<a name="l00254"></a>00254         ds_date <a class="code" href="classcd__control__deck.html#a8cd03bd7e845ec2e1d9e21390c417128" title="Get the current time for the ControlDeck.">current_time</a>();
<a name="l00256"></a>00256         dsim_simulation *<a class="code" href="classcd__control__deck.html#a26a5c2aa470425e516357f1806ca9af7" title="Get access to the simulation used by the ControlDeck (if one is active)">simulation</a>();
<a name="l00258"></a>00258         <a class="code" href="classcd__control__module.html" title="The class from which all user code will be derived.">cd_control_module</a> *<a class="code" href="classcd__control__deck.html#aaba8382d8644e29eb443695827683558" title="Load a module.">load_control_module</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path,<span class="keyword">const</span> <span class="keywordtype">char</span> *type,<span class="keyword">const</span> <span class="keywordtype">char</span> *name,<span class="keyword">const</span> <span class="keywordtype">char</span> *ident=NULL);
<a name="l00259"></a>00259         
<a name="l00260"></a>00260         <span class="keywordtype">void</span> print_variables();
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keyword">private</span>:
<a name="l00263"></a>00263                 <a class="code" href="classcd__control__deck.html#a2744fa2f48bf2bdeb3be519098fdbdf4" title="Create a new control deck, with an optional setup file.">cd_control_deck</a> (<span class="keyword">const</span> <a class="code" href="classcd__control__deck.html" title="ControlDeck manager class.">cd_control_deck</a> &amp;r);
<a name="l00264"></a>00264                 <a class="code" href="classcd__control__deck.html" title="ControlDeck manager class.">cd_control_deck</a> &amp;operator= (<span class="keyword">const</span> <a class="code" href="classcd__control__deck.html" title="ControlDeck manager class.">cd_control_deck</a> &amp;r);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keyword">private</span>:
<a name="l00267"></a>00267         <span class="keywordtype">void</span> cd_xml_parser(<span class="keyword">const</span> <span class="keywordtype">char</span> *control_setup_file);
<a name="l00268"></a>00268         <span class="keywordtype">void</span> cd_text_parser(<span class="keyword">const</span> <span class="keywordtype">char</span> *control_setup_file);
<a name="l00269"></a>00269         <span class="keyword">const</span> <span class="keywordtype">char</span> *parse_setup_file_v1(<span class="keywordtype">void</span> *_doc);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="comment">//void add_variables_from_store(sd_data_store *cdict);</span>
<a name="l00272"></a>00272         <span class="keywordtype">void</span> remove_control_system(<span class="keyword">const</span> <span class="keywordtype">char</span> *name);
<a name="l00273"></a>00273         
<a name="l00274"></a>00274         <span class="comment">// Timers</span>
<a name="l00275"></a>00275         <span class="keywordtype">void</span> request_timer(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">double</span> period,<span class="keywordtype">int</span> code);
<a name="l00276"></a>00276         <span class="keywordtype">void</span> remove_timer(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">int</span> code);
<a name="l00277"></a>00277         <span class="keywordtype">void</span> run_timer(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">int</span> code);
<a name="l00278"></a>00278         
<a name="l00279"></a>00279         <span class="comment">// Background Tasks</span>
<a name="l00280"></a>00280         <span class="keywordtype">void</span> note_background_task_finished(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">void</span> *data,<span class="keywordtype">int</span> code);
<a name="l00281"></a>00281         <span class="keywordtype">void</span> note_background_task_data(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">void</span> *data,<span class="keywordtype">int</span> code);
<a name="l00282"></a>00282         <span class="keywordtype">void</span> complete_background_task(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">void</span> *data,<span class="keywordtype">int</span> code);
<a name="l00283"></a>00283         <span class="keywordtype">void</span> handle_background_task_data(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">void</span> *data,<span class="keywordtype">int</span> code);
<a name="l00284"></a>00284        
<a name="l00285"></a>00285         <span class="comment">// Events</span>
<a name="l00286"></a>00286         <span class="keywordtype">void</span> request_event_notification(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keyword">const</span> <span class="keywordtype">char</span> *group,<span class="keyword">const</span> <span class="keywordtype">char</span> *event_name,<span class="keywordtype">int</span> code);
<a name="l00287"></a>00287         <span class="keywordtype">void</span> trigger_event(<span class="keyword">const</span> <span class="keywordtype">char</span> *group,<span class="keyword">const</span> <span class="keywordtype">char</span> *event_name);
<a name="l00288"></a>00288         <span class="keywordtype">void</span> handle_event(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keywordtype">int</span> code);
<a name="l00289"></a>00289         
<a name="l00290"></a>00290         <span class="comment">// Data</span>
<a name="l00291"></a>00291         <a class="code" href="group___control_deck.html#ga22bf8b5798c2a7f7a2b72c1af21c79ac" title="The data type for manipulating data within the control system.">CD_DATA_REF</a> create_data(<span class="keyword">const</span> <span class="keywordtype">char</span> *group,<span class="keyword">const</span> <span class="keywordtype">char</span> *path,<span class="keywordtype">int</span> type,<span class="keyword">const</span> <span class="keywordtype">char</span> *units,<span class="keyword">const</span> <span class="keywordtype">char</span> *description,<span class="keywordtype">void</span> *initial_value,<span class="keywordtype">bool</span> is_system_group);
<a name="l00292"></a>00292         <a class="code" href="group___control_deck.html#ga22bf8b5798c2a7f7a2b72c1af21c79ac" title="The data type for manipulating data within the control system.">CD_DATA_REF</a> request_data(<span class="keyword">const</span> <span class="keywordtype">char</span> *group,<span class="keyword">const</span> <span class="keywordtype">char</span> *path,<span class="keywordtype">int</span> type);
<a name="l00293"></a>00293         <span class="keyword">const</span> <span class="keywordtype">char</span> *path_for_data(<a class="code" href="group___control_deck.html#ga22bf8b5798c2a7f7a2b72c1af21c79ac" title="The data type for manipulating data within the control system.">CD_DATA_REF</a> point, <span class="keyword">const</span> <span class="keywordtype">char</span> *&amp;group) <span class="keyword">const</span>;
<a name="l00294"></a>00294         <span class="keywordtype">bool</span> delete_data(<a class="code" href="group___control_deck.html#ga22bf8b5798c2a7f7a2b72c1af21c79ac" title="The data type for manipulating data within the control system.">CD_DATA_REF</a> point);
<a name="l00295"></a>00295        
<a name="l00296"></a>00296         <span class="comment">// Logging</span>
<a name="l00297"></a>00297         <span class="keywordtype">void</span> plog(<span class="keyword">const</span> <span class="keywordtype">char</span> *format,...);
<a name="l00298"></a>00298         <span class="keywordtype">void</span> error(<span class="keyword">const</span> <span class="keywordtype">char</span> *file,<span class="keywordtype">int</span> line,<span class="keyword">const</span> <span class="keywordtype">char</span> *format,...);
<a name="l00299"></a>00299         <span class="keywordtype">void</span> vlog(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keyword">const</span> <span class="keywordtype">char</span> *format,va_list arg);
<a name="l00300"></a>00300         <span class="keywordtype">void</span> verror(<span class="keyword">const</span> <span class="keywordtype">char</span> *system,<span class="keyword">const</span> <span class="keywordtype">char</span> *module,<span class="keyword">const</span> <span class="keywordtype">char</span> *file,<span class="keywordtype">int</span> line,<span class="keyword">const</span> <span class="keywordtype">char</span> *format,va_list arg);
<a name="l00301"></a>00301         
<a name="l00302"></a>00302         <span class="comment">// Utility</span>
<a name="l00303"></a>00303         <span class="keywordtype">double</span> scale_seconds(<span class="keywordtype">double</span> seconds);
<a name="l00304"></a>00304         
<a name="l00305"></a>00305         dsim_simulation sim;
<a name="l00306"></a>00306         dsim_variable sim_jd;
<a name="l00307"></a>00307         dsim_variable sim_scale;
<a name="l00308"></a>00308         ds_date next_sim_step;
<a name="l00309"></a>00309         <span class="keywordtype">bool</span> sim_active;
<a name="l00310"></a>00310         
<a name="l00311"></a>00311         ds_character_hash systems;
<a name="l00312"></a>00312         ds_character_hash events;
<a name="l00313"></a>00313         ds_character_hash points;
<a name="l00314"></a>00314         ds_dynamic_array_t timers;
<a name="l00315"></a>00315         ds_dynamic_array_t set_variables;
<a name="l00316"></a>00316         ds_dynamic_array_t mark_variables;
<a name="l00317"></a>00317         ds_dynamic_array_t alias_variables;
<a name="l00318"></a>00318         
<a name="l00319"></a>00319         <span class="comment">// Background task storage</span>
<a name="l00320"></a>00320         ds_dynamic_array_t task_completion;
<a name="l00321"></a>00321         
<a name="l00322"></a>00322         <span class="comment">// Run loop synchronization</span>
<a name="l00323"></a>00323         pthread_mutex_t run_lock;
<a name="l00324"></a>00324         pthread_cond_t run_cond;
<a name="l00325"></a>00325         ds_date next_runloop;
<a name="l00326"></a>00326         
<a name="l00327"></a>00327         <span class="keywordtype">double</span> _scale;
<a name="l00328"></a>00328         
<a name="l00329"></a>00329     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classcd__control__system.html" title="The system class which manages a set of modules.">cd_control_system</a>;
<a name="l00330"></a>00330     
<a name="l00331"></a>00331 };
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 5 2013 17:06:31 for ControlDeck by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
