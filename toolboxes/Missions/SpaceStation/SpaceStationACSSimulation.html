<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>Space Station Attitude Control</title>
<meta name="generator" content="MATLAB 24.1">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2025-06-24">
<meta name="DC.source" content="SpaceStationACSSimulation.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h1>Space Station Attitude Control</h1>
<!--introduction-->
<p>Attitude control with thrusters an reaction wheels with magnetic momentum unloading.</p>
<p>The simulation uses properties generated by ManufacturingSpaceStationCAD.</p>
<p>This file loads SpaceStationProps.mat. It creates output in the file SpaceStationData.txt ------------------------------------------------------------------------ See also RHSSpaceStation, SpaceStationControl, SpaceStationDragDisturbance, PlotOrbit, El2RV, BDipole, Figui, TimeHistory, Date2JD, RK4 ------------------------------------------------------------------------</p>
<!--/introduction-->
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#2">Controls</a>
</li>
<li>
<a href="#3">Initialization</a>
</li>
<li>
<a href="#4">Initialize the dynamics</a>
</li>
<li>
<a href="#5">Initialize the controller</a>
</li>
<li>
<a href="#6">Simulation</a>
</li>
<li>
<a href="#7">Plotting</a>
</li>
</ul>
</div>
<pre class="codeinput">
<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">%   Copyright (c) 2025 Princeton Satellite Systems, Inc.</span>
<span class="comment">%   All rights reserved.</span>
<span class="comment">%--------------------------------------------------------------------------</span>
</pre>
<h2 id="2">Controls</h2>
<pre class="codeinput">aCSOn = true;        <span class="comment">% apply the ACS</span>
useThruster = false; <span class="comment">% use thrusters for ACS (otherwise, wheels)</span>
mUOn = true;         <span class="comment">% momentum unloading</span>
</pre>
<h2 id="3">Initialization</h2>
<pre class="codeinput">jD0 = Date2JD([2029 6 1]);

<span class="comment">% Earth's radius</span>
rE   = 6378.165;

<span class="comment">% Simulation timing</span>
tEnd = 8000.0; <span class="comment">% sec</span>
dT   = 1.0; <span class="comment">% sec</span>

<span class="comment">% Spacecraft altitude</span>
h    = 350.0; <span class="comment">% km</span>

<span class="comment">% Orbit</span>
el    = [rE+h 28.573469*pi/180 pi 0 0 0];
[r,v] = El2RV(el);

<span class="comment">% CAD Model data - without the attached orbiter</span>
dCAD = load(<span class="string">'SpaceStationProps.mat'</span>);
</pre>
<h2 id="4">Initialize the dynamics</h2>
<pre class="codeinput">d           = RHSSpaceStation;
d.inr       = dCAD.mass.inertia;
d.invInr    = inv(d.inr);
d.uThruster = -dCAD.uThruster;  <span class="comment">% reverse plume direction</span>
d.rThruster = dCAD.rThruster;
d.cM        = dCAD.mass.cM;
d.mass      = dCAD.mass.mass;

<span class="comment">% Wheel inertia based on Honeywell HR 16</span>
<span class="comment">% RWA is Reaction Wheel Assembly</span>
omegaSpec = 6000*pi/30;
d.inrRWA  = (75/omegaSpec)*[1;1;1;1];

<span class="comment">% Reaction wheel pyramid about pitch</span>
c         = cos(pi/4);
d.uRWA    = [c -c 0  0;<span class="keyword">...</span>
             c  c c  c;<span class="keyword">...</span>
             0  0 c -c];

<span class="comment">% Drag disturbances</span>
d.dist        = dCAD.dSurf;
d.dist.jD0    = jD0;
d.dist.cM     = dCAD.mass.cM;
d.dist.cD     = 2.7;
</pre>
<h2 id="5">Initialize the controller</h2>
<pre class="codeinput">dACS             = SpaceStationControl(<span class="string">'data structure'</span>);
dACS.inr         = dCAD.mass.inertia; <span class="comment">% kg-m^2</span>
dACS.dT          = dT;
dACS.dTMU        = 20*dT; <span class="comment">% Momentum unloading time step</span>
dACS.uRWA        = d.uRWA;
dACS.inrRWA      = d.inrRWA;
dACS.aCSOn       = aCSOn;
dACS.useThruster = useThruster;
dACS.mUOn        = mUOn;
dACS.uThruster   = -dCAD.uThruster; <span class="comment">% reverse plume direction</span>
dACS.rThruster   = dCAD.rThruster;
dACS.cM          = dCAD.mass.cM;

dACS             = SpaceStationControl(<span class="string">'initialize'</span>,dACS);
</pre>
<h2 id="6">Simulation</h2>
<pre class="codeinput">
<span class="comment">% State vector: [position;velocity;quaternion;body rate;rwa rate]</span>
qS = QUnit(QLVLH(r,v)+[0;0.01;0;0]);
x  = [r;v;qS;0;0;0;10;10;10;10];
n  = ceil(tEnd/dT);
xP = zeros(37,n);

t = (0:n-1)*dT;

<span class="comment">% This creates a data file for use in other applications</span>
fileID = fopen(<span class="string">'SpaceStationData.txt'</span>,<span class="string">'wt'</span>);

TimeDisplay( <span class="string">'initialize'</span>, <span class="string">'Space Station ACS Simulation'</span>, n );
<span class="keyword">for</span> k = 1:n

  <span class="comment">% Environment</span>
  b           = BDipole(x(1:3),jD0+t(k)/86400); <span class="comment">% ECI frame</span>
  dACS.b      = b; <span class="comment">% if measured, would have noise</span>
  d.b         = b; <span class="comment">% truth</span>

  <span class="comment">% Control system</span>
  dACS        = SpaceStationControl(<span class="string">'update'</span>,dACS,x,t(k));
  d.torqueRWA = dACS.torqueRWA;
  d.mDipole   = dACS.m;
  d.fThruster = dACS.fThruster;

  <span class="comment">% Adjust the quaternion so the one term is always positive for plotting</span>
  q = x(7:10);
  <span class="keyword">if</span>( q(1) &lt; 0 )
    q = -q;
  <span class="keyword">end</span>

  <span class="comment">% Get data for plotting</span>
  [~,hECI,torqueD] = RHSSpaceStation(x,t(k),d);
  xP(:,k)     = [x(1:6);q;x(11:end);d.torqueRWA;<span class="keyword">...</span>
                 dACS.dC.q_desired_state;b;dACS.m;hECI;torqueD];

  <span class="comment">% Integrate the right hand side</span>
  x = RK4(@RHSSpaceStation,x,dT,t(k),d);
  fprintf(fileID,<span class="string">'%8.1f %12.2e %12.2e %12.2e %12.2e %12.2e %12.2e %12.2e\n'</span>,t(k),q,r);

  TimeDisplay( <span class="string">'update'</span> );
<span class="keyword">end</span>
TimeDisplay( <span class="string">'close'</span> );

<span class="comment">% Close the data file</span>
fclose(fileID);
</pre>
<h2 id="7">Plotting</h2>
<pre class="codeinput">PlotOrbit( xP(1:3,:), t, jD0 );

yL     = {<span class="string">'r_x'</span> <span class="string">'r_y'</span> <span class="string">'r_z'</span> <span class="keyword">...</span>
          <span class="string">'v_x'</span> <span class="string">'v_y'</span> <span class="string">'v_z'</span> <span class="keyword">...</span>
          <span class="string">'q_s'</span>, <span class="string">'q_x'</span>, <span class="string">'q_y'</span>, <span class="string">'q_z'</span><span class="keyword">...</span>
          <span class="string">'\omega_x (rad/s)'</span>, <span class="string">'\omega_y  (rad/s)'</span>, <span class="string">'\omega_z  (rad/s)'</span>,<span class="keyword">...</span>
          <span class="string">'\omega_1  (rad/s)'</span>, <span class="string">'\omega_2  (rad/s)'</span>, <span class="string">'\omega_3  (rad/s)'</span>, <span class="string">'\omega_4  (rad/s)'</span>,<span class="keyword">...</span>
          <span class="string">'T_1 (Nm)'</span>, <span class="string">'T_2 (Nm)'</span>, <span class="string">'T_3 (Nm)'</span>, <span class="string">'T_4 (Nm)'</span> <span class="keyword">...</span>
          <span class="string">'q_{s_T}'</span>,  <span class="string">'q_{x_T}'</span>,  <span class="string">'q_{y_T}'</span>,  <span class="string">'q_{z_T}'</span> <span class="keyword">...</span>
          <span class="string">'B_x (T) '</span> <span class="string">'B_y (T)'</span> <span class="string">'B_z (T)'</span> <span class="keyword">...</span>
          <span class="string">'M_x (ATM) '</span> <span class="string">'M_y (ATM)'</span> <span class="string">'M_z (ATM)'</span> <span class="keyword">...</span>
          <span class="string">'H_x (Nms) '</span> <span class="string">'H_y (Nms)'</span> <span class="string">'H_z (Nms)'</span> <span class="keyword">...</span>
          <span class="string">'T_{d_x} (Nm)'</span> <span class="string">'T_{d_y} (Nm)'</span> <span class="string">'T_{d_z} (Nm)'</span> };

k      = [7:10 22:25];
kY     = 7:10;
TimeHistory(t,xP(k,:),yL(kY),<span class="string">'Attitude'</span>,{[1 5] [2 6] [3 7] [4 8]});

k      = 11:13;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'Angular Rates'</span>);

k      = 14:17;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'RWA Speeds'</span>);

k      = 18:21;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'RWA Torque'</span>);

k      = 22:25;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'Target Attitude'</span>);

k      = 26:31;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'B and M'</span>);

k      = 32:37;
TimeHistory(t,xP(k,:),yL(k),<span class="string">'H and Disturbance'</span>);

Figui;


<span class="comment">%--------------------------------------</span>

<span class="comment">% $Id: 07b731a836435a81f0e3bdf37033a0605f98dc04 $</span>
</pre>
<img vspace="5" hspace="5" src="SpaceStationACSSimulation_01.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_02.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_03.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_04.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_05.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_06.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_07.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_08.png" alt=""> <img vspace="5" hspace="5" src="SpaceStationACSSimulation_09.png" alt=""> <p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2024a</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% Space Station Attitude Control
% Attitude control with thrusters an reaction wheels with magnetic momentum
% unloading. 
%
% The simulation uses properties generated by ManufacturingSpaceStationCAD.
% 
% This file loads SpaceStationProps.mat. It creates output in the file
% SpaceStationData.txt
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% See also RHSSpaceStation, SpaceStationControl,
% SpaceStationDragDisturbance, PlotOrbit, El2RV, BDipole, Figui,
% TimeHistory, Date2JD, RK4
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%%

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%   Copyright (c) 2025 Princeton Satellite Systems, Inc. 
%   All rights reserved.
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%% Controls
aCSOn = true;        % apply the ACS
useThruster = false; % use thrusters for ACS (otherwise, wheels)
mUOn = true;         % momentum unloading

%% Initialization
jD0 = Date2JD([2029 6 1]);

% Earth's radius
rE   = 6378.165;

% Simulation timing
tEnd = 8000.0; % sec
dT   = 1.0; % sec

% Spacecraft altitude
h    = 350.0; % km

% Orbit 
el    = [rE+h 28.573469*pi/180 pi 0 0 0];
[r,v] = El2RV(el);

% CAD Model data - without the attached orbiter
dCAD = load('SpaceStationProps.mat');

%% Initialize the dynamics
d           = RHSSpaceStation;
d.inr       = dCAD.mass.inertia;
d.invInr    = inv(d.inr);
d.uThruster = -dCAD.uThruster;  % reverse plume direction
d.rThruster = dCAD.rThruster;
d.cM        = dCAD.mass.cM;
d.mass      = dCAD.mass.mass;

% Wheel inertia based on Honeywell HR 16
% RWA is Reaction Wheel Assembly
omegaSpec = 6000*pi/30;
d.inrRWA  = (75/omegaSpec)*[1;1;1;1];

% Reaction wheel pyramid about pitch
c         = cos(pi/4);
d.uRWA    = [c -c 0  0;...
             c  c c  c;...
             0  0 c -c];

% Drag disturbances
d.dist        = dCAD.dSurf;
d.dist.jD0    = jD0;
d.dist.cM     = dCAD.mass.cM;
d.dist.cD     = 2.7;

%% Initialize the controller
dACS             = SpaceStationControl('data structure');
dACS.inr         = dCAD.mass.inertia; % kg-m^2
dACS.dT          = dT;
dACS.dTMU        = 20*dT; % Momentum unloading time step
dACS.uRWA        = d.uRWA;
dACS.inrRWA      = d.inrRWA; 
dACS.aCSOn       = aCSOn;
dACS.useThruster = useThruster;
dACS.mUOn        = mUOn;
dACS.uThruster   = -dCAD.uThruster; % reverse plume direction
dACS.rThruster   = dCAD.rThruster;
dACS.cM          = dCAD.mass.cM;

dACS             = SpaceStationControl('initialize',dACS);

%% Simulation

% State vector: [position;velocity;quaternion;body rate;rwa rate]
qS = QUnit(QLVLH(r,v)+[0;0.01;0;0]);
x  = [r;v;qS;0;0;0;10;10;10;10];
n  = ceil(tEnd/dT);
xP = zeros(37,n);

t = (0:n-1)*dT;

% This creates a data file for use in other applications
fileID = fopen('SpaceStationData.txt','wt');

TimeDisplay( 'initialize', 'Space Station ACS Simulation', n );
for k = 1:n

  % Environment
  b           = BDipole(x(1:3),jD0+t(k)/86400); % ECI frame
  dACS.b      = b; % if measured, would have noise
  d.b         = b; % truth

  % Control system
  dACS        = SpaceStationControl('update',dACS,x,t(k));
  d.torqueRWA = dACS.torqueRWA;
  d.mDipole   = dACS.m;
  d.fThruster = dACS.fThruster;

  % Adjust the quaternion so the one term is always positive for plotting
  q = x(7:10);
  if( q(1) < 0 )
    q = -q;
  end

  % Get data for plotting
  [~,hECI,torqueD] = RHSSpaceStation(x,t(k),d);
  xP(:,k)     = [x(1:6);q;x(11:end);d.torqueRWA;...
                 dACS.dC.q_desired_state;b;dACS.m;hECI;torqueD];
 
  % Integrate the right hand side
  x = RK4(@RHSSpaceStation,x,dT,t(k),d);
  fprintf(fileID,'%8.1f %12.2e %12.2e %12.2e %12.2e %12.2e %12.2e %12.2e\n',t(k),q,r);

  TimeDisplay( 'update' );
end
TimeDisplay( 'close' );

% Close the data file
fclose(fileID);

%% Plotting
        
PlotOrbit( xP(1:3,:), t, jD0 );

yL     = {'r_x' 'r_y' 'r_z' ...
          'v_x' 'v_y' 'v_z' ...
          'q_s', 'q_x', 'q_y', 'q_z'...
          '\omega_x (rad/s)', '\omega_y  (rad/s)', '\omega_z  (rad/s)',...
          '\omega_1  (rad/s)', '\omega_2  (rad/s)', '\omega_3  (rad/s)', '\omega_4  (rad/s)',...
          'T_1 (Nm)', 'T_2 (Nm)', 'T_3 (Nm)', 'T_4 (Nm)' ...
          'q_{s_T}',  'q_{x_T}',  'q_{y_T}',  'q_{z_T}' ...
          'B_x (T) ' 'B_y (T)' 'B_z (T)' ...
          'M_x (ATM) ' 'M_y (ATM)' 'M_z (ATM)' ...
          'H_x (Nms) ' 'H_y (Nms)' 'H_z (Nms)' ...
          'T_{d_x} (Nm)' 'T_{d_y} (Nm)' 'T_{d_z} (Nm)' };

k      = [7:10 22:25];
kY     = 7:10;
TimeHistory(t,xP(k,:),yL(kY),'Attitude',{[1 5] [2 6] [3 7] [4 8]});

k      = 11:13;
TimeHistory(t,xP(k,:),yL(k),'Angular Rates');

k      = 14:17;
TimeHistory(t,xP(k,:),yL(k),'RWA Speeds');

k      = 18:21;
TimeHistory(t,xP(k,:),yL(k),'RWA Torque');

k      = 22:25;
TimeHistory(t,xP(k,:),yL(k),'Target Attitude');

k      = 26:31;
TimeHistory(t,xP(k,:),yL(k),'B and M');

k      = 32:37;
TimeHistory(t,xP(k,:),yL(k),'H and Disturbance');

Figui;


%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% $Date:   2025-05-21 $
% $Id: 07b731a836435a81f0e3bdf37033a0605f98dc04 $

##### SOURCE END #####
-->
</body>
</html>
